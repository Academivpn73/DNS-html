// server.js
// Academi DNS Panel - Backend Full
// یک فایل کامل برای اجرا در Node.js

import express from "express";
import cors from "cors";
import { Resolver } from "dns";
import { performance } from "perf_hooks";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// ====== لیست DNS اولیه (می‌تونی بعداً کامل‌ترش کنی یا خودکار آپدیتش کنی) ======
let dnsList = [
  {
    name: "Cloudflare",
    country: "us",
    ipv4: ["1.1.1.1", "1.0.0.1"],
    ipv6: ["2606:4700:4700::1111", "2606:4700:4700::1001"],
  },
  {
    name: "Google",
    country: "us",
    ipv4: ["8.8.8.8", "8.8.4.4"],
    ipv6: ["2001:4860:4860::8888", "2001:4860:4860::8844"],
  },
  {
    name: "Quad9",
    country: "de",
    ipv4: ["9.9.9.9", "149.112.112.112"],
    ipv6: ["2620:fe::fe", "2620:fe::9"],
  },
  {
    name: "Shecan",
    country: "ir",
    ipv4: ["178.22.122.100", "185.51.200.2"],
    ipv6: [],
  },
  {
    name: "403 Online",
    country: "ir",
    ipv4: ["10.202.10.202", "10.202.10.102"],
    ipv6: [],
  },
];

// ====== تابع پینگ (زمان پاسخ DNS resolve) ======
async function measureDNS(ip, testDomain = "example.com") {
  return new Promise((resolve) => {
    const resolver = new Resolver();
    resolver.setServers([ip]);
    const t0 = performance.now();
    let done = false;

    const timer = setTimeout(() => {
      if (!done) {
        done = true;
        resolve(null);
      }
    }, 4000);

    resolver.resolve(testDomain, (err) => {
      if (done) return;
      done = true;
      clearTimeout(timer);
      if (err) return resolve(null);
      const ms = Math.round(performance.now() - t0);
      resolve(ms);
    });
  });
}

// ====== APIها ======

// همه DNSها
app.get("/dns", (req, res) => {
  res.json(dnsList);
});

// جنریت DNS بر اساس کشور / نوع / تعداد
app.get("/generate", async (req, res) => {
  const { country = "", type = "ipv4", count = 2 } = req.query;
  let list = dnsList;

  if (country) {
    list = list.filter(
      (d) => d.country.toLowerCase() === country.toString().toLowerCase()
    );
  }

  let ips = [];
  for (const d of list) {
    if (type === "ipv6") ips.push(...d.ipv6.map((ip) => ({ ...d, ip })));
    else ips.push(...d.ipv4.map((ip) => ({ ...d, ip })));
  }

  // تصادفی انتخاب کن
  ips = ips.sort(() => 0.5 - Math.random()).slice(0, count);

  // پینگ واقعی
  const results = [];
  for (const item of ips) {
    const ping = await measureDNS(item.ip);
    results.push({
      name: item.name,
      country: item.country,
      ip: item.ip,
      type: item.ip.includes(":") ? "IPv6" : "IPv4",
      ping: ping ? `${ping}ms` : "timeout",
    });
  }

  res.json(results);
});

// تست پینگ یک DNS
app.get("/ping", async (req, res) => {
  const { ip } = req.query;
  if (!ip) return res.status(400).json({ error: "ip required" });

  const ping = await measureDNS(ip);
  res.json({
    ip,
    ping: ping ? `${ping}ms` : "timeout",
  });
});

// تست دو DNS (اولیه + ثانویه)
app.post("/ping-dual", async (req, res) => {
  const { primary, secondary } = req.body;
  if (!primary || !secondary)
    return res.status(400).json({ error: "primary & secondary required" });

  const p1 = await measureDNS(primary);
  const p2 = await measureDNS(secondary);

  res.json({
    primary: { ip: primary, ping: p1 ? `${p1}ms` : "timeout" },
    secondary: { ip: secondary, ping: p2 ? `${p2}ms` : "timeout" },
  });
});

// دانلود DNS تحریم‌شکن (مثال)
app.get("/download", async (req, res) => {
  const { count = 2 } = req.query;
  const filter = dnsList.filter((d) => d.country === "ir"); // مثلا ایرانی
  let ips = [];
  for (const d of filter) {
    ips.push(...d.ipv4.map((ip) => ({ ...d, ip })));
  }
  ips = ips.sort(() => 0.5 - Math.random()).slice(0, count);

  const results = [];
  for (const item of ips) {
    const ping = await measureDNS(item.ip);
    results.push({
      name: item.name,
      ip: item.ip,
      type: "IPv4",
      ping: ping ? `${ping}ms` : "timeout",
    });
  }

  res.json(results);
});

// ====== شروع سرور ======
app.listen(PORT, () => {
  console.log(`Academi DNS server running on http://localhost:${PORT}`);
});
